<!doctype html>
<head><meta charset="utf8">
<title>SIMD.js value semantics proposal</title>
<link rel="stylesheet" href="./elements.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
</head><body><emu-biblio href="./biblio.json"></emu-biblio>
<h1>SIMD.js value semantics proposal</h1>
<div><h2>Table of Contents</h2><ol class="toc"><li><a href="#intro"><span class="secnum"></span> Introduction</a></li><li><a href="#all-types"><span class="secnum">1</span> ECMAScript language types (6.1)</a><ol class="toc"><li><a href="#intrinsics"><span class="secnum">1.1</span> Well-Known Intrinsic Objects (6.1.7.4)</a></li></ol></li><li><a href="#types"><span class="secnum">2</span> SIMD types (6.1.8)</a><ol class="toc"><li><a href="#type"><span class="secnum">2.1</span> Float32x4 (6.1.8.1)</a></li></ol></li><li><a href="#"><span class="secnum">3</span> Abstract Operations (7)</a><ol class="toc"><li><a href="#"><span class="secnum">3.1</span> Type Conversion (7.1)</a><ol class="toc"><li><a href="#to-primitive"><span class="secnum">3.1.1</span> ToPrimitive ( input [, PreferredType] ) (7.1.1)</a></li><li><a href="#to-boolean"><span class="secnum">3.1.2</span> ToBoolean ( argument ) (7.1.2)</a></li><li><a href="#to-number"><span class="secnum">3.1.3</span> ToNumber ( argument ) (7.1.3)</a></li><li><a href="#to-string"><span class="secnum">3.1.4</span> ToString ( argument ) (7.1.12)</a></li><li><a href="#to-object"><span class="secnum">3.1.5</span> ToObject ( argument ) (7.1.13)</a></li></ol></li><li><a href="#require-object-coercible"><span class="secnum">3.2</span> RequireObjectCoercible ( argument ) (7.2.1)</a></li><li><a href="#same-value"><span class="secnum">3.3</span> SameValue(x, y) (7.2.9)</a></li><li><a href="#same-value-zero"><span class="secnum">3.4</span> SameValueZero(x, y) (7.2.10)</a></li><li><a href="#abstract-relational-comparison"><span class="secnum">3.5</span> Abstract relational comparison (7.2.11)</a></li><li><a href="#abstract-equality"><span class="secnum">3.6</span> Abstract Equality Comparison (7.2.12)</a></li><li><a href="#strict-equality-comparison"><span class="secnum">3.7</span> Strict Equality Comparison (7.2.13)</a></li></ol></li><li><a href="#"><span class="secnum">4</span> The typeof Operator (12.5.6)</a><ol class="toc"><li><a href="#"><span class="secnum">4.1</span> Runtime Semantics: Evaluation (12.5.6.1)</a></li></ol></li><li><a href="#"><span class="secnum">5</span> Constructor properties of the global object (18.3)</a><ol class="toc"><li><a href="#"><span class="secnum">5.1</span> Float32x4 (18.3.34)</a></li></ol></li><li><a href="#simd"><span class="secnum">6</span> SIMD objects (27)</a><ol class="toc"><li><a href="#simd-float32x4"><span class="secnum">6.1</span> Float32x4 objects (27.1)</a><ol class="toc"><li><a href="#float32x4-constructor"><span class="secnum">6.1.1</span> The Float32x4 constructor (27.1.1)</a><ol class="toc"><li><a href="#float32x4-wrap"><span class="secnum">6.1.1.1</span> Float32x4( value ) (27.1.1.1)</a></li><li><a href="#float32x4-make"><span class="secnum">6.1.1.2</span> Float32x4( x, y, z, w ) (27.1.1.2)</a><ol class="toc"><li><a href="#extract-lane"><span class="secnum">6.1.1.2.1</span> SIMD.Float32x4.extractLane(t, i) (27.1.1.3)</a></li><li><a href="#add"><span class="secnum">6.1.1.2.2</span> SIMD.Float32x4.add(a, b) (27.1.1.3)</a></li></ol></li></ol></li><li><a href="#"><span class="secnum">6.1.2</span> The SIMD.Float32x4.prototype (27.1.2)</a><ol class="toc"><li><a href="#"><span class="secnum">6.1.2.1</span> SIMD.Float32x4.prototype.constructor (27.1.2.1)</a></li></ol></li></ol></li></ol></li></ol></div><emu-intro id="intro">
<h1><span class="secnum"></span>Introduction</h1>
<p>
This proposal adds SIMD types and operations to Javascript, focusing on the value semantics. The proposal adds new primitive types Float32x4, etc, together with wrappers and a definition of their behavior in the language. The proposal discusses Float32x4 and just a couple functions on it, with the idea that it would extend similarly to other SIMD types. Rough definitions for more types and functions that operate on them can be found at <a href="https://github.com/johnmccutchan/ecmascript_simd/blob/master/tc39/simd-spec262.md">the SIMD.js spec</a>.
</p>

<p>
One problem that this spec aims to solve is to define equality for SIMD values. Existing implementations use object identity-based equality. However, maintaining object identity puts a big burden on compilers to maintain this identity through operations, where they would rather be able to duplicate and de-duplicate SIMD values arbitrarily based on algebraic identities. By making SIMD values into primitive types with structural equality, compilers are given more freedom.
</p>

<p>
Ideally, SIMD values will fit into a larger value types proposal. Such a proposal would be a bit more involved, but good work has already been done in that direction. This document describes SIMD without a larger value type system, but it aims to be consistent with how value types might work, and once someone steps forward to describe value types in more detail, it will be great to simplify this text by just explaining SIMD in terms of value types. On the other hand, this proposal gives a vehicle to work out some of the issues in value types and can be used as a guide for future value type designs.
</p>

<p>
This document is organized in terms of where changes would be made to the ES6 spec. Although ecmarkup generates numbering at the beginning of headers, these won't correspond to the numbering within the existing ECMA spec, so I've included a matching numbering in parentheses afterwards, referring to the ES6 spec. I also intend to add crossreferencing links where appropriate.
</p>

<p>
Related links:
</p>
<ul>
<li><a href="https://github.com/nikomatsakis/typed-objects-explainer/blob/master/valuetypes.md">Value types proposal</a></li>
<li><a href="https://github.com/johnmccutchan/ecmascript_simd/blob/master/src/ecmascript_simd.js">SIMD polyfill</a></li>
<li><a href="https://github.com/johnmccutchan/ecmascript_simd/issues/157">Bug about SIMD.js value semantics</a></li>
</ul>
</emu-intro>

<emu-clause id="all-types">
<h1><span class="secnum">1</span>ECMAScript language types (<a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-language-types">6.1</a>)</h1>
<emu-clause id="intrinsics">
<h1><span class="secnum">1.1</span>Well-Known Intrinsic Objects (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-well-known-intrinsic-objects">6.1.7.4</a>)</h1>
<p>
<strong>Intrinsic name</strong>: %SIMD%
<br>
<strong>Global name</strong>: <code>SIMD</code>
<br>
<strong>ECMAScript Language Association</strong>: The <code>SIMD</code> object (<a href="#simd">27</a>)
</p>

<p>
<strong>Intrinsic name</strong>: %SIMDFloat32x4%
<br>
<strong>Global name</strong>: <code>SIMD.Float32x4</code>
<br>
<strong>ECMAScript Language Association</strong>: The <code>SIMD.Float32x4</code> constructor (<a href="#float32x4-constructor">27.1.1</a>)
</p>

<p>
<strong>Intrinsic name</strong>: %SIMDFloat32x4Prototype%
<br>
<strong>Global name</strong>: SIMD.Float32x4.prototype
<br>
<strong>ECMAScript Language Association</strong>: The initial value of the prototype data property of %SIMDFLoat32x4% (27.1.2)
</p>
</emu-clause>
</emu-clause>

<emu-clause id="types">
<h1><span class="secnum">2</span>SIMD types (6.1.8)</h1>
<emu-clause id="type">
<h1><span class="secnum">2.1</span>Float32x4 (6.1.8.1)</h1>

<p>
<code>Float32x4</code> is a SIMD type representing four 32-bit floating point values. Float32x4 values can be created using the [[Call]] operation on the <a href="#float32x4-constructor">SIMD.Float32x4</a> object, described in 27.1.1.
</p>
</emu-clause>
</emu-clause>

<emu-clause>
<h1><span class="secnum">3</span>Abstract Operations (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-abstract-operations">7</a>)</h1>

<emu-clause>
<h1><span class="secnum">3.1</span>Type Conversion (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-type-conversion">7.1</a>)</h1>

<emu-clause id="to-primitive">
<h1><span class="secnum">3.1.1</span>ToPrimitive ( input [, PreferredType] ) (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-toprimitive">7.1.1</a>)</h1>

<strong>Argument type</strong>: <code>Float32x4</code>
<br>
<strong>Result</strong>: return <var>input</var>

<emu-note><span class="note">Note</span>
An additional option considered is to define this as calling ToObject on it, and then ToPrimitive on the resulting wrapper object. This would have the advantage of allowing toString and valueOf be defined on the wrapper prototype, which seems more realistic to me as a path for value types.
</emu-note>
</emu-clause>

<emu-clause id="to-boolean">
<h1><span class="secnum">3.1.2</span>ToBoolean ( argument ) (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-toboolean">7.1.2</a>)</h1>

<strong>Argument type</strong>: <code>Float32x4</code>
<br>
<strong>Result</strong>: return <emu-const>true</emu-const>

<emu-note><span class="note">Note</span>
Even if it would be consistent to return false if it is all zero, there probably isn't much gain from adding more falsy values.
</emu-note>
</emu-clause>

<emu-clause id="to-number">
<h1><span class="secnum">3.1.3</span>ToNumber ( argument ) (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-tonumber">7.1.3</a>)</h1>

<strong>Argument type</strong>: <code>Float32x4</code>
<br>
<strong>Result</strong>: throw a <emu-const>TypeError</emu-const> exception
</emu-clause>

<emu-clause id="to-string">
<h1><span class="secnum">3.1.4</span>ToString ( argument ) (7.1.12)</h1>

<strong>Argument type</strong>: Float32x4
<br>
<strong>Result</strong>: Return "SIMD.Float32x4(" + ToString(ExtractLane(argument, 0)) + ", " + ToString(ExtractLane(argument, 1)) + ", " + ToString(ExtractLane(argument, 2)) + ", " + ToString(ExtractLane(argument, 3)) + ")"

<emu-note><span class="note">Note</span>An alternative would be to call ToObject and let the wrapper handle ToString the way it works for objects.</emu-note>
</emu-clause>

<emu-clause id="to-object">
<h1><span class="secnum">3.1.5</span>ToObject ( argument ) (7.1.13)</h1>

<strong>Argument type</strong>: Float32x4
<br>
<strong>Result</strong>: Return a new %SIMDFloat32x4% object whose [[Float32x4Data]] internal slot is set to argument. See 27.1 for a description of %SIMDFloat32x4% objects.
</emu-clause>
</emu-clause>

<emu-clause id="require-object-coercible">
<h1><span class="secnum">3.2</span>RequireObjectCoercible ( argument ) (7.2.1)</h1>

<strong>Argument type</strong>: Float32x4
<br>
<strong>Result</strong>: return argument
</emu-clause>

<emu-clause id="same-value">
<h1><span class="secnum">3.3</span>SameValue(x, y) (7.2.9)</h1>
Add an extra step at the bottom of the definition of SameValue for the new case involving the new type:
<emu-alg><ol start="11">
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(x) is Float32x4, then
    <ol>
      <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevalue">SameValue</a>(x.[[Float32x4X]], y.[[Float32x4X]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevalue">SameValue</a>(x.[[Float32x4Y]], y.[[Float32x4Y]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevalue">SameValue</a>(x.[[Float32x4Z]], y.[[Float32x4Z]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevalue">SameValue</a>(x.[[Float32x4W]], y.[[Float32x4W]]), return true, otherwise return false</li>
    </ol>
  </li>
</ol></emu-alg>
</emu-clause>

<emu-clause id="same-value-zero">
<h1><span class="secnum">3.4</span>SameValueZero(x, y) (7.2.10)</h1>
Add an extra step at the bottom of the definition of SameValue for the new case involving the new type:
<emu-alg><ol start="11">
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(x) is Float32x4, then
    <ol>
      <li>Assert: <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(y) is Float32x4</li>
      <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevaluezero">SameValueZero</a>(x.[[Float32x4X]], y.[[Float32x4X]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevaluezero">SameValueZero</a>(x.[[Float32x4Y]], y.[[Float32x4Y]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevaluezero">SameValueZero</a>(x.[[Float32x4Z]], y.[[Float32x4Z]]) and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-samevaluezero">SameValueZero</a>(x.[[Float32x4W]], y.[[Float32x4W]]), return <emu-const>true</emu-const>, otherwise return <emu-const>false</emu-const></li>
    </ol>
  </li>
</ol></emu-alg>
</emu-clause>

<emu-clause id="abstract-relational-comparison">
<h1><span class="secnum">3.5</span>Abstract relational comparison (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-abstract-relational-comparison">7.2.11</a>)</h1>
<emu-note><span class="note">Note</span>No changes needed for SIMD; it will just compare them as strings with the current defintion.</emu-note>
</emu-clause>

<emu-clause id="abstract-equality">
<h1><span class="secnum">3.6</span>Abstract Equality Comparison (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-abstract-equality-comparison">7.2.12</a>)</h1>
Replace step 10 with the following:
<emu-alg><ol start="10">
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(x) is either String, Number, Symbol, or Float32x4, and <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(y) is Object, then return the result of the comparison x == <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-toprimitive">ToPrimitive</a>(y).</li>
</ol></emu-alg>
</emu-clause>

<emu-clause id="strict-equality-comparison">
<h1><span class="secnum">3.7</span>Strict Equality Comparison (<a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-strict-equality-comparison">7.2.13</a>)</h1>
Add a new step 9, before the existing step 9:
<emu-alg><ol start="9">
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(x) is Float32x4, then
    <ol>
      <li>If x.[[Float32x4X]] === y.[[Float32x4X]] and x.[[Float32x4Y]] === y.[[Float32x4Y]] and x.[[Float32x4Z]] === y.[[Float32x4Z]] and x.[[Float32x4W]] === y.[[Float32x4W]], return true</li>
      <li>Else, return false</li>
    </ol>
  </li>
</ol></emu-alg>
</emu-clause>
</emu-clause>

<emu-clause>
<h1><span class="secnum">4</span>The typeof Operator (12.5.6)</h1>
<emu-clause>
<h1><span class="secnum">4.1</span>Runtime Semantics: Evaluation (12.5.6.1)</h1>

<strong>Type of val</strong>: Float32x4
<br>
<strong>Result</strong>: "float32x4"
</emu-clause>
</emu-clause>

<emu-clause>
<h1><span class="secnum">5</span>Constructor properties of the global object (18.3)</h1>
<emu-clause>
<h1><span class="secnum">5.1</span>Float32x4 (18.3.34)</h1>

See <a href="#simd-float32x4">27.1</a>
</emu-clause>
</emu-clause>

<emu-clause id="simd">
<h1><span class="secnum">6</span>SIMD objects (27)</h1>

The SIMD global object has several constructor properties, one for each SIMD type

<emu-clause id="simd-float32x4">
<h1><span class="secnum">6.1</span>Float32x4 objects (27.1)</h1>

<emu-note><span class="note">Note</span>
As with Boolean, String, etc, this is a constructor for the wrapper when invoked with new, and returns a primitive when called as a function.
</emu-note>

<emu-clause id="float32x4-constructor">
<h1><span class="secnum">6.1.1</span>The Float32x4 constructor (27.1.1)</h1>

<emu-note><span class="note">Note</span>
The Float32x4 constructor reachable from the global object as SIMD.Float32x4. It is sometimes referred to in this spec as %SIMDFloat32x4% to reduce ambiguity and emphasize that, even if the SIMD object is modified or shadowed, references in this spec refer to the original binding.
</emu-note>

<emu-clause id="float32x4-wrap">
<h1><span class="secnum">6.1.1.1</span>Float32x4( value ) (27.1.1.1)</h1>

This description applies if Float32x4 is called with exactly one argument.

<emu-alg><ol>
  <li>If NewTarget is undefined, throw a ReferenceError (NB: TypeError?)</li>
  <li>If value is not of the type Float32x4, throw a TypeError</li>
  <li>Let O be <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ordinarycreatefromconstructor">OrdinaryCreateFromConstructor</a>(NewTarget, <code>"%SIMDFloat32x4Prototype%"</code>, «[[Float32x4Data]]» ).</li>
  <li><a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-returnifabrupt">ReturnIfAbrupt</a>(O).</li>
  <li>Set the value of O’s [[Float32x4Data]] internal slot to n.</li>
  <li>Return O.</li>
</ol></emu-alg>
</emu-clause>

<emu-clause id="float32x4-make">
<h1><span class="secnum">6.1.1.2</span>Float32x4( x, y, z, w ) (27.1.1.2)</h1>

This description applies if Float32x4 is called with exactly four arguments. If it is called with a different number of arguments from one or four, throw a TypeError (NB: Or, call this version, with some things being undefined and/or some values ignored?)

<emu-alg><ol>
  <li>Let xf be ToFloat32(x)</li>
  <li><a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-returnifabrupt">ReturnIfAbrupt</a>(xf)</li>
  <li>Let yf be ToFloat32(y)</li>
  <li><a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-returnifabrupt">ReturnIfAbrupt</a>(yf)</li>
  <li>Let xf be ToFloat32(z)</li>
  <li><a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-returnifabrupt">ReturnIfAbrupt</a>(zf)</li>
  <li>Let yf be ToFloat32(w)</li>
  <li><a href="http://people.mozilla.org/~jorendorff/es6-draft.html#sec-returnifabrupt">ReturnIfAbrupt</a>(wf)</li>
  <li>Return a Float32x4 primitive with the internal slots { [[Float32x4X]]: xf, [[Float32x4Y]]: yf, [[Float32x4Z]]: zf, [[Float32x4W]]: wf}</li>
</ol></emu-alg>

<emu-clause id="extract-lane">
<h1><span class="secnum">6.1.1.2.1</span>SIMD.Float32x4.extractLane(t, i) (27.1.1.3)</h1>

<emu-alg><ol>
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(t) is not Float32x4, throw a TypeError exception</li>
  <li>Let index be <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-tonumber">ToNumber</a>(i)</li>
  <li>If i is 0, return t.[[Float32x4X]]</li>
  <li>If i is 1, return t.[[Float32x4Y]]</li>
  <li>If i is 2, return t.[[Float32x4Z]]</li>
  <li>If i is 3, return t.[[Float32x4W]]</li>
  <li>Else, return ReferenceError</li>
</ol></emu-alg>
</emu-clause>

<emu-clause id="add">
<h1><span class="secnum">6.1.1.2.2</span>SIMD.Float32x4.add(a, b) (27.1.1.3)</h1>

<emu-alg><ol>
  <li>If <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(a) is not Float32x4 or <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-ecmascript-data-types-and-values">Type</a>(b) is not Float32x4, throw a TypeError exception</li>
  <li>Return a Float32 with the internal slots {[[Float32x4X]]: ToFloat32(a.[[Float32x4X]] + b.[[Float32x4X]]), [[Float32x4Y]]: ToFloat32(a.[[Float32x4Y]] + b.[[Float32x4Y]]), [[Float32x4Z]]: ToFloat32(a.[[Float32x4Z]] + b.[[Float32x4Z]]), [[Float32x4W]]: ToFloat32(a.[[Float32x4W]] + b.[[Float32x4W]])}</li>
</ol></emu-alg>
</emu-clause>

<!--
27.1.1.3 splat

27.1.1.3 replaceLane

27.1.1.3 check
-->

</emu-clause>
</emu-clause>

<emu-clause>
<h1><span class="secnum">6.1.2</span>The SIMD.Float32x4.prototype (27.1.2)</h1>

<emu-note><span class="note">Note</span>
Previously, if accessors like x were included, these would be spec'd as getters (with null setter) on the SIMD.Float32x4.prototype . However, they have been removed in favor of SIMD.Float32x4.extractLane. Are there any non-trivial properties? Users could add methods like .add() here if they want to use SIMD in an object-oriented way.
</emu-note>

<emu-clause>
<h1><span class="secnum">6.1.2.1</span>SIMD.Float32x4.prototype.constructor (27.1.2.1)</h1>

The initial value of SIMD.Float32x4.prototype.constructor is the intrinsic object %SIMDFloat32x4%
</emu-clause>
</emu-clause>
</emu-clause>
</emu-clause>
</body>